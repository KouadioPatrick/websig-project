name: ğŸ—ºï¸ Mise Ã  jour automatique des donnÃ©es SIG

# DÃ©clencheurs
on:
  # PlanifiÃ©: chaque lundi Ã  6h00 UTC (7h en hiver, 8h en Ã©tÃ© en France)
  schedule:
    - cron: '0 6 * * 1'  # Minute Heure Jour Mois JourSemaine
  
  # DÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      reason:
        description: 'Raison du dÃ©clenchement manuel'
        required: false
        default: 'Mise Ã  jour manuelle'

# Permissions nÃ©cessaires
permissions:
  contents: write  # Pour commit et push

jobs:
  update-data:
    name: Traitement et mise Ã  jour des donnÃ©es
    runs-on: ubuntu-latest
    
    steps:
      # === 1. CHECKOUT DU DÃ‰PÃ”T ===
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historique complet pour rollback Ã©ventuel
      
      # === 2. CONFIGURATION PYTHON ===
      - name: ğŸ Configuration Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache des dÃ©pendances
      
      # === 3. INSTALLATION DES DÃ‰PENDANCES ===
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      # === 4. UPLOAD DES FICHIERS SOURCES ===
      # âš ï¸ IMPORTANT: Vous devez uploader vos fichiers SIG manuellement
      # Option 1: Via l'interface GitHub (Actions > Artifacts)
      # Option 2: Via secrets/variables pour chemins externes
      # Option 3: Depuis un stockage cloud (voir section alternatives)
      
      - name: ğŸ“‚ VÃ©rification des fichiers sources
        run: |
          echo "ğŸ“‹ Contenu de data/raw/:"
          ls -lh data/raw/ || echo "âš ï¸ Dossier data/raw vide ou absent"
          echo ""
          echo "ğŸ’¡ RAPPEL: Uploadez vos fichiers sources dans data/raw/"
      
      # === 5. EXÃ‰CUTION DU SCRIPT PYTHON ===
      - name: ğŸ”„ Traitement des donnÃ©es SIG
        id: process
        run: |
          cd scripts
          python process_data.py
        continue-on-error: false  # ArrÃªt si erreur
      
      # === 6. VÃ‰RIFICATION DES FICHIERS GÃ‰NÃ‰RÃ‰S ===
      - name: âœ… VÃ©rification des GeoJSON gÃ©nÃ©rÃ©s
        run: |
          echo "ğŸ“Š Fichiers GeoJSON gÃ©nÃ©rÃ©s:"
          ls -lh data/processed/*.geojson
          echo ""
          echo "ğŸ“ˆ Statistiques:"
          for file in data/processed/*.geojson; do
            echo "  - $(basename $file): $(wc -l < $file) lignes, $(du -h $file | cut -f1)"
          done
      
      # === 7. COMMIT ET PUSH ===
      - name: ğŸ’¾ Commit des nouvelles donnÃ©es
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Ajouter uniquement les fichiers processed
          git add data/processed/*.geojson
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Aucun changement dÃ©tectÃ©, pas de commit"
          else
            # CrÃ©er un message de commit informatif
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ—ºï¸ Mise Ã  jour automatique des donnÃ©es SIG - $TIMESTAMP
            
            Traitement effectuÃ© par GitHub Actions
            Raison: ${{ github.event.inputs.reason || 'Mise Ã  jour planifiÃ©e' }}
            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}"
            
            # Push vers la branche principale
            git push
            echo "âœ… DonnÃ©es mises Ã  jour et poussÃ©es sur GitHub"
          fi
      
      # === 8. UPLOAD DES LOGS ===
      - name: ğŸ“‹ Upload des logs
        if: always()  # MÃªme en cas d'Ã©chec
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_id }}
          path: logs/*.log
          retention-days: 30
      
      # === 9. NOTIFICATION EN CAS D'Ã‰CHEC ===
      - name: ğŸ“§ Notification d'Ã©chec
        if: failure()
        run: |
          echo "âŒ Le workflow a Ã©chouÃ©!"
          echo "ğŸ“‹ Consultez les logs dans les artifacts"
          echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # TODO: Ajouter ici votre systÃ¨me de notification
          # Exemples: email, Slack, Discord, etc.

# === GESTION DES ERREURS ET ROLLBACK ===
  rollback-on-failure:
    name: Rollback en cas d'Ã©chec
    runs-on: ubuntu-latest
    needs: update-data
    if: failure()
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # RÃ©cupÃ©rer les 2 derniers commits
      
      - name: â®ï¸ Rollback au commit prÃ©cÃ©dent
        run: |
          echo "ğŸ”„ Rollback vers le commit prÃ©cÃ©dent..."
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Revenir au commit prÃ©cÃ©dent pour data/processed/
          git checkout HEAD~1 -- data/processed/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Rien Ã  restaurer"
          else
            git commit -m "â®ï¸ Rollback automatique aprÃ¨s Ã©chec - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Rollback effectuÃ© avec succÃ¨s"
          fi